<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Akka系列（七）：Actor持久化之Akka persistence &#8211; GodPan</title>
<meta name="description" content="这次把这部分内容提到现在写，是因为这段时间开发的项目刚好在这一块遇到了一些难点，所以准备把经验分享给大家，我们在使用Akka时，会经常遇到一些存储Actor内部状态的场景，在系统正常运行的情况下，我们不需要担心什么，但是当系统出错，比如Actor错误需要重启，或者内存溢出，亦或者整个系统崩溃，如果我们不采取一定的方案的话，在系统重启时Actor的状态就会丢失，这会导致我们丢失一些关键的数据，造成系统数据不一致的问题。Akka作为一款成熟的生产环境应用，为我们提供了相应的解决方案就是Akka persistence。

">
<meta name="keywords" content="">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Akka系列（七）：Actor持久化之Akka persistence">
<meta name="twitter:description" content="这次把这部分内容提到现在写，是因为这段时间开发的项目刚好在这一块遇到了一些难点，所以准备把经验分享给大家，我们在使用Akka时，会经常遇到一些存储Actor内部状态的场景，在系统正常运行的情况下，我们不需要担心什么，但是当系统出错，比如Actor错误需要重启，或者内存溢出，亦或者整个系统崩溃，如果我们不采取一定的方案的话，在系统重启时Actor的状态就会丢失，这会导致我们丢失一些关键的数据，造成系统数据不一致的问题。Akka作为一款成熟的生产环境应用，为我们提供了相应的解决方案就是Akka persistence。

">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/site-logo.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Akka系列（七）：Actor持久化之Akka persistence">
<meta property="og:description" content="这次把这部分内容提到现在写，是因为这段时间开发的项目刚好在这一块遇到了一些难点，所以准备把经验分享给大家，我们在使用Akka时，会经常遇到一些存储Actor内部状态的场景，在系统正常运行的情况下，我们不需要担心什么，但是当系统出错，比如Actor错误需要重启，或者内存溢出，亦或者整个系统崩溃，如果我们不采取一定的方案的话，在系统重启时Actor的状态就会丢失，这会导致我们丢失一些关键的数据，造成系统数据不一致的问题。Akka作为一款成熟的生产环境应用，为我们提供了相应的解决方案就是Akka persistence。

">
<meta property="og:url" content="/blog/akka-7/">
<meta property="og:site_name" content="GodPan">





<link rel="canonical" href="/blog/akka-7/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="GodPan Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?97a996faebe648d21debdaf60f01d40b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="/assets/js/vendor/html5shiv.min.js"></script>
  <script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>



<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
  <nav role="navigation" id="site-nav" class="animated drop">
      <ul>
      
        
        <li><a href="/about/" >About</a></li>
      
        
        <li><a href="/articles/" >Articles</a></li>
      
        
        <li><a href="/blog/" >Blog</a></li>
      
      </ul>
  </nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          
        </ul>
        
          <h1 class="entry-title">Akka系列（七）：Actor持久化之Akka persistence</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/bio-photo.jpg" class="bio-photo" alt="GodPan bio photo"></a>
        
        <span class="author vcard">By <span class="fn">GodPan</span></span>
        <span class="entry-date date published"><time datetime="2017-07-22T00:00:00+08:00"><i class="fa fa-calendar-o"></i> July 22, 2017</time></span>
        
        
        
        
      </footer>
      <div class="entry-content">
        <p>这次把这部分内容提到现在写，是因为这段时间开发的项目刚好在这一块遇到了一些难点，所以准备把经验分享给大家，我们在使用Akka时，会经常遇到一些存储Actor内部状态的场景，在系统正常运行的情况下，我们不需要担心什么，但是当系统出错，比如Actor错误需要重启，或者内存溢出，亦或者整个系统崩溃，如果我们不采取一定的方案的话，在系统重启时Actor的状态就会丢失，这会导致我们丢失一些关键的数据，造成系统数据不一致的问题。Akka作为一款成熟的生产环境应用，为我们提供了相应的解决方案就是Akka persistence。</p>

<h3 id="actor">为什么需要持久化的Actor？</h3>

<p>万变不离其宗，数据的一致性是永恒的主题，一个性能再好的系统，不能保证数据的正确，也称不上是一个好的系统，一个系统在运行的时候难免会出错，如何保证系统在出错后能正确的恢复数据，不让数据出现混乱是一个难题。使用Actor模型的时候，我们会有这么一个想法，就是能不对数据库操作就尽量不对数据库操作（这里我们假定我们的数据库是安全，可靠的，能保证数据的正确性和一致性，比如使用国内某云的云数据库），一方面如果大量的数据操作会使数据库面临的巨大的压力，导致崩溃，另一方面即使数据库能处理的过来，比如一些count，update的大表操作也会消耗很多的时间，远没有内存中直接操作来的快，大大影响性能。但是又有人说几人内存操作这么快，为什么不把数据都放内存中呢？答案显而易见，当出现机器死机，或者内存溢出等问题时，数据很有可能就丢失了导致无法恢复。在这种背景下，我们是不是有一种比较好的解决方案，既能满足需求又能用最小的性能消耗，答案就是上面我们的说的Akka persistence。</p>

<h3 id="akka-persistence">Akka persistence的核心架构</h3>

<p>在具体深入Akka persistence之前，我们可以先了解一下它的核心设计理念，其实简单来说，我们可以利用一些thing来恢复Actor的状态，这里的thing可以是日志、数据库中的数据，亦或者是文件，所以说它的本质非常容易理解，在Actor处理的时候我们会保存一些数据，Actor在恢复的时候能根据这些数据恢复其自身的状态。</p>

<p>所以Akka persistence 有以下几个关键部分组成：</p>

<ul>
  <li>PersistentActor：任何一个需要持久化的Actor都必须继承它，并必须定义或者实现其中的三个关键属性：</li>
</ul>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code> <span class="k">def</span> <span class="n">persistenceId</span> <span class="k">=</span> <span class="s">"example"</span> <span class="c1">//作为持久化Actor的唯一表示，用于持久化或者查询时使用
</span>
 <span class="k">def</span> <span class="n">receiveCommand</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">???</span> <span class="c1">//Actor正常运行时处理处理消息逻辑，可在这部分内容里持久化自己想要的消息
</span>
 <span class="k">def</span> <span class="n">receiveRecover</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">???</span> <span class="c1">//Actor重启恢复是执行的逻辑
</span></code></pre>
</div>
<p>相比普通的Actor，除receiveCommand相似以外，还必须实现另外两个属性。
另外在持久化Actor中还有另外两个关键的的概念就是<em>Journal</em>和<em>Snapshot</em>，前者用于持久化事件，后者用于保存Actor的快照，两者在Actor恢复状态的时候都起到了至关重要的作用。</p>

<h3 id="akka-persistencedemo">Akka persistence的demo实战</h3>

<p>这里我首先会用一个demo让大家能对Akka persistence的使用有一定了解的，并能大致明白它的工作原理，后面再继续讲解一些实战可能会遇到的问题。</p>

<p>假定现在有这么一个场景，现在假设有一个1w元的大红包，瞬间可能会很多人同时来抢，每个人抢的金额也可能不一样，场景很简单，实现方式也有很多种，但前提是保证数据的正确性，比如最普通的使用数据库保证，但对这方面有所了解的同学都知道这并不是一个很好的方案，因为需要锁，并需要大量的数据库操作，导致性能不高，那么我们是否可以用Actor来实现这个需求么？答案是当然可以。</p>

<p>我们首先来定义一个抽奖命令，</p>
<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">LotteryCmd</span><span class="o">(</span>
  <span class="n">userId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span> <span class="c1">// 参与用户Id
</span>  <span class="n">username</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span> <span class="c1">//参与用户名
</span>  <span class="n">email</span><span class="k">:</span> <span class="kt">String</span> <span class="c1">// 参与用户邮箱
</span><span class="o">)</span>
</code></pre>
</div>
<p>然后我们实现一个抽奖Actor，并继承PersistentActor作出相应的实现：</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">case</span> <span class="k">class</span> <span class="nc">LuckyEvent</span><span class="o">(</span>  <span class="c1">//抽奖成功事件
</span>    <span class="n">userId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
    <span class="n">luckyMoney</span><span class="k">:</span> <span class="kt">Int</span>
<span class="o">)</span>
<span class="k">case</span> <span class="k">class</span> <span class="nc">FailureEvent</span><span class="o">(</span>  <span class="c1">//抽奖失败事件
</span>    <span class="n">userId</span><span class="k">:</span> <span class="kt">Long</span><span class="o">,</span>
    <span class="n">reason</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">)</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Lottery</span><span class="o">(</span>
    <span class="n">totalAmount</span><span class="k">:</span> <span class="kt">Int</span><span class="o">,</span>  <span class="c1">//红包总金额
</span>    <span class="n">remainAmount</span><span class="k">:</span> <span class="kt">Int</span>  <span class="c1">//剩余红包金额
</span><span class="o">)</span> <span class="o">{</span>
  <span class="k">def</span> <span class="n">update</span><span class="o">(</span><span class="n">luckyMoney</span><span class="k">:</span> <span class="kt">Int</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>
    <span class="n">copy</span><span class="o">(</span>
      <span class="n">remainAmount</span> <span class="k">=</span> <span class="n">remainAmount</span> <span class="o">-</span> <span class="n">luckyMoney</span>
    <span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
<span class="k">class</span> <span class="nc">LotteryActor</span><span class="o">(</span><span class="n">initState</span><span class="k">:</span> <span class="kt">Lottery</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">PersistentActor</span> <span class="k">with</span> <span class="nc">ActorLogging</span><span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">persistenceId</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"lottery-actor-1"</span>

  <span class="k">var</span> <span class="n">state</span> <span class="k">=</span> <span class="n">initState</span>  <span class="c1">//初始化Actor的状态
</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">receiveRecover</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">event</span><span class="k">:</span> <span class="kt">LuckyEvent</span> <span class="o">=&gt;</span>
      <span class="n">updateState</span><span class="o">(</span><span class="n">event</span><span class="o">)</span>  <span class="c1">//恢复Actor时根据持久化的事件恢复Actor状态
</span>    <span class="k">case</span> <span class="nc">SnapshotOffer</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">snapshot</span><span class="k">:</span> <span class="kt">Lottery</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Recover actor state from snapshot and the snapshot is ${snapshot}"</span><span class="o">)</span>
      <span class="n">state</span> <span class="k">=</span> <span class="n">snapshot</span> <span class="c1">//利用快照恢复Actor的状态
</span>    <span class="k">case</span> <span class="nc">RecoveryCompleted</span> <span class="k">=&gt;</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">"the actor recover completed"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">updateState</span><span class="o">(</span><span class="n">le</span><span class="k">:</span> <span class="kt">LuckyEvent</span><span class="o">)</span> <span class="k">=</span>
    <span class="n">state</span> <span class="k">=</span> <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">le</span><span class="o">.</span><span class="n">luckyMoney</span><span class="o">)</span>  <span class="c1">//更新自身状态
</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">receiveCommand</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">lc</span><span class="k">:</span> <span class="kt">LotteryCmd</span> <span class="o">=&gt;</span>
      <span class="n">doLottery</span><span class="o">(</span><span class="n">lc</span><span class="o">)</span> <span class="k">match</span> <span class="o">{</span>     <span class="c1">//进行抽奖，并得到抽奖结果，根据结果做出不同的处理
</span>        <span class="k">case</span> <span class="n">le</span><span class="k">:</span> <span class="kt">LuckyEvent</span> <span class="o">=&gt;</span>  <span class="c1">//抽到随机红包
</span>          <span class="n">persist</span><span class="o">(</span><span class="n">le</span><span class="o">)</span> <span class="o">{</span> <span class="n">event</span> <span class="k">=&gt;</span>
            <span class="n">updateState</span><span class="o">(</span><span class="n">event</span><span class="o">)</span>
            <span class="n">increaseEvtCountAndSnapshot</span><span class="o">()</span>
            <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="n">event</span>
          <span class="o">}</span>
        <span class="k">case</span> <span class="n">fe</span><span class="k">:</span> <span class="kt">FailureEvent</span> <span class="o">=&gt;</span>  <span class="c1">//红包已经抽完
</span>          <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="n">fe</span>
      <span class="o">}</span>
    <span class="k">case</span> <span class="s">"saveSnapshot"</span> <span class="k">=&gt;</span>  <span class="c1">// 接收存储快照命令执行存储快照操作
</span>      <span class="n">saveSnapshot</span><span class="o">(</span><span class="n">state</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">SaveSnapshotSuccess</span><span class="o">(</span><span class="n">metadata</span><span class="o">)</span> <span class="k">=&gt;</span>  <span class="o">???</span>  <span class="c1">//你可以在快照存储成功后做一些操作，比如删除之前的快照等
</span>  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">increaseEvtCountAndSnapshot</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">snapShotInterval</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lastSequenceNr</span> <span class="o">%</span> <span class="n">snapShotInterval</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">lastSequenceNr</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">//当有持久化5个事件后我们便存储一次当前Actor状态的快照
</span>      <span class="n">self</span> <span class="o">!</span> <span class="s">"saveSnapshot"</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">doLottery</span><span class="o">(</span><span class="n">lc</span><span class="k">:</span> <span class="kt">LotteryCmd</span><span class="o">)</span> <span class="k">=</span> <span class="o">{</span>  <span class="c1">//抽奖逻辑具体实现
</span>    <span class="k">if</span> <span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="n">remainAmount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">val</span> <span class="n">luckyMoney</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">(</span><span class="n">state</span><span class="o">.</span><span class="n">remainAmount</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span>
      <span class="nc">LuckyEvent</span><span class="o">(</span><span class="n">lc</span><span class="o">.</span><span class="n">userId</span><span class="o">,</span> <span class="n">luckyMoney</span><span class="o">)</span>
    <span class="o">}</span>
    <span class="k">else</span> <span class="o">{</span>
      <span class="nc">FailureEvent</span><span class="o">(</span><span class="n">lc</span><span class="o">.</span><span class="n">userId</span><span class="o">,</span> <span class="s">"下次早点来，红包已被抽完咯！"</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>程序很简单，关键位置我也给了注释，相信大家对Actor有所了解的话很容易理解，当然要是有些疑惑，可以看看我之前写的文章，下面我们就对刚才写的抽红包Actor进行测试：</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">object</span> <span class="nc">PersistenceTest</span> <span class="k">extends</span> <span class="nc">App</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">lottery</span> <span class="k">=</span> <span class="nc">Lottery</span><span class="o">(</span><span class="mi">10000</span><span class="o">,</span><span class="mi">10000</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">system</span> <span class="k">=</span> <span class="nc">ActorSystem</span><span class="o">(</span><span class="s">"example-05"</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">lotteryActor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">(</span><span class="k">new</span> <span class="nc">LotteryActor</span><span class="o">(</span><span class="n">lottery</span><span class="o">)),</span> <span class="s">"LotteryActor-1"</span><span class="o">)</span>  <span class="c1">//创建抽奖Actor
</span>  <span class="k">val</span> <span class="n">pool</span><span class="k">:</span> <span class="kt">ExecutorService</span> <span class="o">=</span> <span class="nc">Executors</span><span class="o">.</span><span class="n">newFixedThreadPool</span><span class="o">(</span><span class="mi">10</span><span class="o">)</span>
  <span class="k">val</span> <span class="n">r</span> <span class="k">=</span> <span class="o">(</span><span class="mi">1</span> <span class="n">to</span> <span class="mi">100</span><span class="o">).</span><span class="n">map</span><span class="o">(</span><span class="n">i</span> <span class="k">=&gt;</span>
    <span class="k">new</span> <span class="nc">LotteryRun</span><span class="o">(</span><span class="n">lotteryActor</span><span class="o">,</span> <span class="nc">LotteryCmd</span><span class="o">(</span><span class="n">i</span><span class="o">.</span><span class="n">toLong</span><span class="o">,</span><span class="s">"godpan"</span><span class="o">,</span><span class="s">"xx@gmail.com"</span><span class="o">))</span>  <span class="c1">//创建100个抽奖请求
</span>  <span class="o">)</span>
  <span class="n">r</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">pool</span><span class="o">.</span><span class="n">execute</span><span class="o">(</span><span class="k">_</span><span class="o">))</span>  <span class="c1">//使用线程池来发起抽奖请求，模拟同时多人参加
</span>  <span class="nc">Thread</span><span class="o">.</span><span class="n">sleep</span><span class="o">(</span><span class="mi">5000</span><span class="o">)</span>
  <span class="n">pool</span><span class="o">.</span><span class="n">shutdown</span><span class="o">()</span>
  <span class="n">system</span><span class="o">.</span><span class="n">terminate</span><span class="o">()</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">LotteryRun</span><span class="o">(</span><span class="n">lotteryActor</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">,</span> <span class="n">lotteryCmd</span><span class="k">:</span> <span class="kt">LotteryCmd</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">Runnable</span> <span class="o">{</span> <span class="c1">//抽奖请求
</span>  <span class="k">implicit</span> <span class="k">val</span> <span class="n">timeout</span> <span class="k">=</span> <span class="nc">Timeout</span><span class="o">(</span><span class="mf">3.</span><span class="n">seconds</span><span class="o">)</span>
  <span class="k">def</span> <span class="n">run</span><span class="k">:</span> <span class="kt">Unit</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">for</span> <span class="o">{</span>
      <span class="n">fut</span> <span class="k">&lt;-</span> <span class="n">lotteryActor</span> <span class="o">?</span> <span class="n">lotteryCmd</span>
    <span class="o">}</span> <span class="k">yield</span> <span class="n">fut</span> <span class="k">match</span> <span class="o">{</span>  <span class="c1">//根据不同事件显示不同的抽奖结果
</span>      <span class="k">case</span> <span class="n">le</span><span class="k">:</span> <span class="kt">LuckyEvent</span> <span class="o">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"恭喜用户${le.userId}抽到了${le.luckyMoney}元红包"</span><span class="o">)</span>
      <span class="k">case</span> <span class="n">fe</span><span class="k">:</span> <span class="kt">FailureEvent</span> <span class="o">=&gt;</span>  <span class="n">println</span><span class="o">(</span><span class="n">fe</span><span class="o">.</span><span class="n">reason</span><span class="o">)</span>
      <span class="k">case</span> <span class="k">_</span> <span class="k">=&gt;</span> <span class="n">println</span><span class="o">(</span><span class="s">"系统错误，请重新抽取"</span><span class="o">)</span>
    <span class="o">}</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>运行程序,我们可能看到以下的结果：</p>

<p><img src="/images/2017/07/result-persistence-demo.png" alt="result persistence demo" /></p>

<p>下面我会把persistence actor在整个运行过程的步骤给出，帮助大家理解它的原理：</p>

<ul>
  <li>1.初始化Persistence Actor
    <ul>
      <li>1.1若是第一次初始化，则与正常的Actor的初始化一致。</li>
      <li>1.2若是重启恢复Actor，这根据Actor之前持久的数据恢复。
        <ul>
          <li>1.2.1从快照恢复，可快速恢复Actor，但并非每次持久化事件都会保存快照，在快照完整的情况下，Actor优先从快照恢复自身状态。</li>
          <li>1.2.2从事件（日志，数据库记录等）恢复，通过重放持久化事件恢复Actor状态，比较关键。</li>
        </ul>
      </li>
    </ul>
  </li>
  <li>
    <p>2.接收命令进行处理，转化为需要持久化的事件（持久化的事件尽量只包含关键性的数据）使用Persistence Actor的持久化方法进行持久化（上述例子中的persist，后面我会讲一下批量持久化），并处理持久化成功后的逻辑处理，比如修改Actor状态，向外部Actor发送消息等。</p>
  </li>
  <li>3.若是我们需要存储快照，那么可以主动指定存储快照的频率，比如持久化事件100次我们就存储一次快照，这个频率应该要考虑实际的业务场景，在存储快照成功后我们也可以执行一些操作。</li>
</ul>

<p>总的来说Persistence Actor运行时的大致操作就是以上这些，当然它是持久化事件等有兴趣的可以看一下Akka源码。</p>

<h3 id="akka-persistence-1">使用Akka persistence的相关配置</h3>

<p>首先我们必须加载相应的依赖包，在<code class="highlighter-rouge">bulid.sbt</code>中加入以下依赖：</p>

<div class="highlighter-rouge"><pre class="highlight"><code>libraryDependencies ++= Seq(
"com.typesafe.akka" %% "akka-actor" % "2.4.16",  //Akka actor 核心依赖
  "com.typesafe.akka" %% "akka-persistence" % "2.4.16", //Akka persistence 依赖
  "org.iq80.leveldb"            % "leveldb"          % "0.7", //leveldb java版本依赖
  "org.fusesource.leveldbjni"   % "leveldbjni-all"   % "1.8", //leveldb java版本依赖
  "com.twitter"              %% "chill-akka"                  % "0.8.0" //事件序列化依赖
)
</code></pre>
</div>

<p>另外我们还需在<code class="highlighter-rouge">application.conf</code>加入以下配置:</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">akka</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">plugin</span> <span class="k">=</span> <span class="s">"akka.persistence.journal.leveldb"</span>
<span class="n">akka</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">snapshot</span><span class="o">-</span><span class="n">store</span><span class="o">.</span><span class="n">plugin</span> <span class="k">=</span> <span class="s">"akka.persistence.snapshot-store.local"</span>

<span class="n">akka</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">leveldb</span><span class="o">.</span><span class="n">dir</span> <span class="k">=</span> <span class="s">"log/journal"</span>
<span class="n">akka</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">snapshot</span><span class="o">-</span><span class="n">store</span><span class="o">.</span><span class="n">local</span><span class="o">.</span><span class="n">dir</span> <span class="k">=</span> <span class="s">"log/snapshots"</span>

<span class="k">#</span> <span class="nc">DO</span> <span class="nc">NOT</span> <span class="nc">USE</span> <span class="nc">THIS</span> <span class="nc">IN</span> <span class="nc">PRODUCTION</span> <span class="o">!!!</span>
<span class="k">#</span> <span class="nc">See</span> <span class="n">also</span> <span class="n">https</span><span class="o">://</span><span class="n">github</span><span class="o">.</span><span class="n">com</span><span class="o">/</span><span class="n">typesafehub</span><span class="o">/</span><span class="n">activator</span><span class="o">/</span><span class="n">issues</span><span class="o">/</span><span class="mi">287</span>
<span class="n">akka</span><span class="o">.</span><span class="n">persistence</span><span class="o">.</span><span class="n">journal</span><span class="o">.</span><span class="n">leveldb</span><span class="o">.</span><span class="n">native</span> <span class="k">=</span> <span class="kc">false</span>  <span class="c1">//因为我们本地并没有安装leveldb，所以这个属性置为false，但是生产环境并不推荐使用
</span>
<span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">serializers</span> <span class="o">{</span>
  <span class="n">kryo</span> <span class="k">=</span> <span class="s">"com.twitter.chill.akka.AkkaSerializer"</span>
<span class="o">}</span>

<span class="n">akka</span><span class="o">.</span><span class="n">actor</span><span class="o">.</span><span class="n">serialization</span><span class="o">-</span><span class="n">bindings</span> <span class="o">{</span>
  <span class="s">"scala.Product"</span> <span class="k">=</span> <span class="n">kryo</span>
  <span class="s">"akka.persistence.PersistentRepr"</span> <span class="k">=</span> <span class="n">kryo</span>
<span class="o">}</span>
</code></pre>
</div>

<p>至此为止我们整个Akka persistence demo已经搭建好了，可以正常运行了，有兴趣的同学可以下载源码。<a href="https://github.com/godpan/akka-demo/tree/master/Example_05">源码链接</a></p>

<h3 id="akka-persistence-2">Akka persistence进阶</h3>

<h4 id="section">1.持久化插件</h4>

<p>有同学可能会问，我对leveldb不是很熟悉亦或者觉得单机存储并不是安全，有没有支持分布式数据存储的插件呢，比如某爸的云数据库？答案当然是有咯，良心的我当然是帮你们都找好咯。</p>

<ul>
  <li>
    <p>1.akka-persistence-sql-async: 支持MySQL和PostgreSQL，另外使用了全异步的数据库驱动，提供异步非阻塞的API，我司用的就是它的变种版，6的飞起。<a href="https://github.com/okumin/akka-persistence-sql-async">项目地址</a></p>
  </li>
  <li>
    <p>2.akka-persistence-cassandra: 官方推荐的插件，使用写性能very very very fast的cassandra数据库，是几个插件中比较流行的一个，另外它还支持persistence query。<a href="https://github.com/krasserm/akka-persistence-cassandra">项目地址</a></p>
  </li>
  <li>
    <p>3.akka-persistence-redis: redis应该也很符合Akka persistence的场景，熟悉redis的同学可以使用看看。<a href="https://github.com/hootsuite/akka-persistence-redis">项目地址</a></p>
  </li>
  <li>
    <p>4.akka-persistence-jdbc: 怎么能少了jdbc呢？不然怎么对的起java爸爸呢，支持scala和java哦。<a href="https://github.com/dnvriend/akka-persistence-jdbc">项目地址</a></p>
  </li>
</ul>

<p>相应的插件的具体使用可以看该项目的具体介绍使用，我看了下相对来说都是比较容易的。</p>

<h4 id="section-1">2.批量持久化</h4>

<p>上面说到我司用的是akka-persistence-sql-async插件，所以我们是将事件和快照持久化到数据库的，一开始我也是像上面demo一样，每次事件都会持久化到数据库，但是后来在性能测试的时候，因为本身业务场景对数据库的压力也比较大，在当数据库到达每秒1000+的读写量后，另外说明一下使用的是某云数据库，性能中配以上，发现每次持久化的时间将近要15ms，这样换算一下的话Actor每秒只能处理60~70个需要持久化的事件，而实际业务场景要求Actor必须在3秒内返回处理结果，这种情况下导致大量消息处理超时得不到反馈，另外还有大量的消息得不到处理，导致系统错误暴增，用户体验下降，既然我们发现了问题，那么我们能不能进行优化呢?事实上当然是可以，既然单个插入慢，那么我们能不能批量插入呢，Akka persistence为我们提供了persistAll方法，下面我就对上面的demo进行一下改造，让其变成批量持久化：</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">LotteryActorN</span><span class="o">(</span><span class="n">initState</span><span class="k">:</span> <span class="kt">Lottery</span><span class="o">)</span> <span class="k">extends</span> <span class="nc">PersistentActor</span> <span class="k">with</span> <span class="nc">ActorLogging</span><span class="o">{</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">persistenceId</span><span class="k">:</span> <span class="kt">String</span> <span class="o">=</span> <span class="s">"lottery-actor-2"</span>

  <span class="k">var</span> <span class="n">state</span> <span class="k">=</span> <span class="n">initState</span>  <span class="c1">//初始化Actor的状态
</span>
  <span class="k">override</span> <span class="k">def</span> <span class="n">receiveRecover</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">event</span><span class="k">:</span> <span class="kt">LuckyEvent</span> <span class="o">=&gt;</span>
      <span class="n">updateState</span><span class="o">(</span><span class="n">event</span><span class="o">)</span>  <span class="c1">//恢复Actor时根据持久化的事件恢复Actor状态
</span>    <span class="k">case</span> <span class="nc">SnapshotOffer</span><span class="o">(</span><span class="k">_</span><span class="o">,</span> <span class="n">snapshot</span><span class="k">:</span> <span class="kt">Lottery</span><span class="o">)</span> <span class="k">=&gt;</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">s</span><span class="s">"Recover actor state from snapshot and the snapshot is ${snapshot}"</span><span class="o">)</span>
      <span class="n">state</span> <span class="k">=</span> <span class="n">snapshot</span> <span class="c1">//利用快照恢复Actor的状态
</span>    <span class="k">case</span> <span class="nc">RecoveryCompleted</span> <span class="k">=&gt;</span> <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="s">"the actor recover completed"</span><span class="o">)</span>
  <span class="o">}</span>

  <span class="k">def</span> <span class="n">updateState</span><span class="o">(</span><span class="n">le</span><span class="k">:</span> <span class="kt">LuckyEvent</span><span class="o">)</span> <span class="k">=</span>
    <span class="n">state</span> <span class="k">=</span> <span class="n">state</span><span class="o">.</span><span class="n">update</span><span class="o">(</span><span class="n">le</span><span class="o">.</span><span class="n">luckyMoney</span><span class="o">)</span>  <span class="c1">//更新自身状态
</span>
  <span class="k">var</span> <span class="n">lotteryQueue</span> <span class="k">:</span> <span class="kt">ArrayBuffer</span><span class="o">[(</span><span class="kt">LotteryCmd</span>, <span class="kt">ActorRef</span><span class="o">)]</span> <span class="k">=</span> <span class="nc">ArrayBuffer</span><span class="o">()</span>

  <span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">.</span><span class="n">scheduler</span>  <span class="c1">//定时器，定时触发抽奖逻辑
</span>    <span class="o">.</span><span class="n">schedule</span><span class="o">(</span>
      <span class="mf">0.</span><span class="n">milliseconds</span><span class="o">,</span>
      <span class="mf">100.</span><span class="n">milliseconds</span><span class="o">,</span>
      <span class="k">new</span> <span class="nc">Runnable</span> <span class="o">{</span>
        <span class="k">def</span> <span class="n">run</span> <span class="k">=</span> <span class="o">{</span>
          <span class="n">self</span> <span class="o">!</span> <span class="s">"doLottery"</span>
        <span class="o">}</span>
      <span class="o">}</span>
    <span class="o">)</span>

  <span class="k">override</span> <span class="k">def</span> <span class="n">receiveCommand</span><span class="k">:</span> <span class="kt">Receive</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">lc</span><span class="k">:</span> <span class="kt">LotteryCmd</span> <span class="o">=&gt;</span>
      <span class="n">lotteryQueue</span> <span class="k">=</span> <span class="n">lotteryQueue</span> <span class="o">:+</span> <span class="o">(</span><span class="n">lc</span><span class="o">,</span> <span class="n">sender</span><span class="o">())</span>  <span class="c1">//参与信息加入抽奖队列
</span>      <span class="n">println</span><span class="o">(</span><span class="n">s</span><span class="s">"the lotteryQueue size is ${lotteryQueue.size}"</span><span class="o">)</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">lotteryQueue</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">5</span><span class="o">)</span>  <span class="c1">//当参与人数有5个时触发抽奖
</span>        <span class="n">joinN</span><span class="o">(</span><span class="n">lotteryQueue</span><span class="o">)</span>
    <span class="k">case</span> <span class="s">"doLottery"</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">lotteryQueue</span><span class="o">.</span><span class="n">size</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span>
        <span class="n">joinN</span><span class="o">(</span><span class="n">lotteryQueue</span><span class="o">)</span>
    <span class="k">case</span> <span class="s">"saveSnapshot"</span> <span class="k">=&gt;</span>  <span class="c1">// 接收存储快照命令执行存储快照操作
</span>      <span class="n">saveSnapshot</span><span class="o">(</span><span class="n">state</span><span class="o">)</span>
    <span class="k">case</span> <span class="nc">SaveSnapshotSuccess</span><span class="o">(</span><span class="n">metadata</span><span class="o">)</span> <span class="k">=&gt;</span>  <span class="o">???</span>  <span class="c1">//你可以在快照存储成功后做一些操作，比如删除之前的快照等
</span>  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">joinN</span><span class="o">(</span><span class="n">lotteryQueue</span><span class="k">:</span> <span class="kt">ArrayBuffer</span><span class="o">[(</span><span class="kt">LotteryCmd</span>, <span class="kt">ActorRef</span><span class="o">)])</span> <span class="k">=</span> <span class="o">{</span>  <span class="c1">//批量处理抽奖结果
</span>    <span class="k">val</span> <span class="n">rs</span> <span class="k">=</span> <span class="n">doLotteryN</span><span class="o">(</span><span class="n">lotteryQueue</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">success</span> <span class="k">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">collect</span> <span class="o">{</span>  <span class="c1">//得到其中中奖的相应信息
</span>      <span class="k">case</span> <span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">LuckyEvent</span><span class="o">,</span> <span class="n">ref</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">=&gt;</span>
        <span class="n">event</span> <span class="o">-&gt;</span> <span class="n">ref</span>
    <span class="o">}.</span><span class="n">toMap</span>
    <span class="n">println</span><span class="o">(</span><span class="n">success</span><span class="o">)</span>
    <span class="k">val</span> <span class="n">failure</span> <span class="k">=</span> <span class="n">rs</span><span class="o">.</span><span class="n">collect</span> <span class="o">{</span>  <span class="c1">//得到其中未中奖的相应信息
</span>      <span class="k">case</span> <span class="o">(</span><span class="n">event</span><span class="k">:</span> <span class="kt">FailureEvent</span><span class="o">,</span> <span class="n">ref</span><span class="k">:</span> <span class="kt">ActorRef</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">event</span> <span class="o">-&gt;</span> <span class="n">ref</span>
    <span class="o">}</span>
    <span class="n">persistAll</span><span class="o">(</span><span class="n">success</span><span class="o">.</span><span class="n">keys</span><span class="o">.</span><span class="n">toIndexedSeq</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">//批量持久化中奖用户事件
</span>      <span class="k">case</span> <span class="n">event</span> <span class="k">=&gt;</span>  <span class="n">println</span><span class="o">(</span><span class="n">event</span><span class="o">)</span>
        <span class="n">updateState</span><span class="o">(</span><span class="n">event</span><span class="o">)</span>
        <span class="n">increaseEvtCountAndSnapshot</span><span class="o">()</span>
        <span class="n">success</span><span class="o">(</span><span class="n">event</span><span class="o">)</span> <span class="o">!</span> <span class="n">event</span>
    <span class="o">}</span>
    <span class="n">failure</span><span class="o">.</span><span class="n">foreach</span> <span class="o">{</span>
      <span class="k">case</span> <span class="o">(</span><span class="n">event</span><span class="o">,</span> <span class="n">ref</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="n">ref</span> <span class="o">!</span> <span class="n">event</span>
    <span class="o">}</span>
    <span class="k">this</span><span class="o">.</span><span class="n">lotteryQueue</span><span class="o">.</span><span class="n">clear</span><span class="o">()</span>  <span class="c1">//情况参与队列
</span>  <span class="o">}</span>


  <span class="k">private</span> <span class="k">def</span> <span class="n">increaseEvtCountAndSnapshot</span><span class="o">()</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">val</span> <span class="n">snapShotInterval</span> <span class="k">=</span> <span class="mi">5</span>
    <span class="k">if</span> <span class="o">(</span><span class="n">lastSequenceNr</span> <span class="o">%</span> <span class="n">snapShotInterval</span> <span class="o">==</span> <span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="n">lastSequenceNr</span> <span class="o">!=</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>  <span class="c1">//当有持久化5个事件后我们便存储一次当前Actor状态的快照
</span>      <span class="n">self</span> <span class="o">!</span> <span class="s">"saveSnapshot"</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="k">private</span> <span class="k">def</span> <span class="n">doLotteryN</span><span class="o">(</span><span class="n">lotteryQueue</span><span class="k">:</span> <span class="kt">ArrayBuffer</span><span class="o">[(</span><span class="kt">LotteryCmd</span>, <span class="kt">ActorRef</span><span class="o">)])</span> <span class="k">=</span> <span class="o">{</span>  <span class="c1">//抽奖逻辑具体实现
</span>    <span class="k">var</span> <span class="n">remainAmount</span> <span class="k">=</span> <span class="n">state</span><span class="o">.</span><span class="n">remainAmount</span>
    <span class="n">lotteryQueue</span><span class="o">.</span><span class="n">map</span><span class="o">(</span><span class="n">lq</span> <span class="k">=&gt;</span>
      <span class="k">if</span> <span class="o">(</span><span class="n">remainAmount</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">val</span> <span class="n">luckyMoney</span> <span class="k">=</span> <span class="n">scala</span><span class="o">.</span><span class="n">util</span><span class="o">.</span><span class="nc">Random</span><span class="o">.</span><span class="n">nextInt</span><span class="o">(</span><span class="n">remainAmount</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span>
        <span class="n">remainAmount</span> <span class="k">=</span> <span class="n">remainAmount</span> <span class="o">-</span> <span class="n">luckyMoney</span>
        <span class="o">(</span><span class="nc">LuckyEvent</span><span class="o">(</span><span class="n">lq</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">userId</span><span class="o">,</span> <span class="n">luckyMoney</span><span class="o">),</span><span class="n">lq</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
      <span class="o">}</span>
      <span class="k">else</span> <span class="o">{</span>
        <span class="o">(</span><span class="nc">FailureEvent</span><span class="o">(</span><span class="n">lq</span><span class="o">.</span><span class="n">_1</span><span class="o">.</span><span class="n">userId</span><span class="o">,</span> <span class="s">"下次早点来，红包已被抽完咯！"</span><span class="o">),</span><span class="n">lq</span><span class="o">.</span><span class="n">_2</span><span class="o">)</span>
      <span class="o">}</span>
    <span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>
<p>这是改造后的参与Actor，实现了批量持久的功能，当然这里为了给发送者返回消息，处理逻辑稍微复杂了一点，不过真实场景可能会更复杂，相关源码也在刚才的项目上。</p>

<h4 id="persistence-query">3.Persistence Query</h4>

<p>另外Akka Persistence还提供了Query接口，用于需要查询持久化事件的需求，这部分内容可能要根据实际业务场景考虑是否需要应用，我就不展开讲了，另外我也写了一个小demo在项目中，想要尝试的同学也可以试试。</p>


        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <div class="correct-tip-box">
      <span>文章允许转载、使用，但需要保留文章署名
<a href="http://www.godpan.me">godpan.me</a>,如有写的不当之处，也欢迎大家指正，联系邮箱：godpan.sen@gmail.com</span>
    </div>
    <nav class="pagination" role="navigation">
      
        <a href="/blog/akka-6/" class="btn" title="Akka系列（六）：Actor解决了什么问题？">Previous</a>
      
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->
<!-- 
<div class="correct-tip-box">
    <span>文章允许转载、使用，但需要保留文章署名
<a href="http://www.godpan.me">godpan.me</a>,如有写的不当之处，也欢迎大家指正，联系邮箱：godpan.sen@gmail.com</span>
</div> -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2017 GodPan.</span>
<div class="social-icons">
	
	
	
	
	
	
	
	<a href="https://github.com/godpan" title="GodPan on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?97a996faebe648d21debdaf60f01d40b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script src="http://scala.cool/lib/jquery/jquery-3.1.1.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>




</body>
</html>
