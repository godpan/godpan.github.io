<!doctype html>
<!--[if lt IE 7]><html class="no-js lt-ie9 lt-ie8 lt-ie7" lang="en"> <![endif]-->
<!--[if (IE 7)&!(IEMobile)]><html class="no-js lt-ie9 lt-ie8" lang="en"><![endif]-->
<!--[if (IE 8)&!(IEMobile)]><html class="no-js lt-ie9" lang="en"><![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en"><!--<![endif]-->
<head>
<meta charset="utf-8">
<title>Akka系列（三）：监管与容错 &#8211; GodPan</title>
<meta name="description" content="Akka作为一种成熟的生产环境并发解决方案，必须拥有一套完善的错误异常处理机制，本文主要讲讲Akka中的监管和容错。

">
<meta name="keywords" content="">


<!-- Twitter Cards -->
<meta name="twitter:title" content="Akka系列（三）：监管与容错">
<meta name="twitter:description" content="Akka作为一种成熟的生产环境并发解决方案，必须拥有一套完善的错误异常处理机制，本文主要讲讲Akka中的监管和容错。

">



<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="/images/site-logo.png">

<!-- Open Graph -->
<meta property="og:locale" content="en_US">
<meta property="og:type" content="article">
<meta property="og:title" content="Akka系列（三）：监管与容错">
<meta property="og:description" content="Akka作为一种成熟的生产环境并发解决方案，必须拥有一套完善的错误异常处理机制，本文主要讲讲Akka中的监管和容错。

">
<meta property="og:url" content="/blog/akka-3/">
<meta property="og:site_name" content="GodPan">





<link rel="canonical" href="/blog/akka-3/">
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title="GodPan Feed">

<!-- https://t.co/dKP3o1e -->
<meta name="HandheldFriendly" content="True">
<meta name="MobileOptimized" content="320">
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- For all browsers -->
<link rel="stylesheet" href="/assets/css/main.css">
<!-- Webfonts -->
<script src="https://use.edgefonts.net/source-sans-pro:n2,i2,n3,i3,n4,i4,n6,i6,n7,i7,n9,i9;source-code-pro:n4,n7;volkhov.js"></script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?97a996faebe648d21debdaf60f01d40b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<meta http-equiv="cleartype" content="on">

<!-- HTML5 Shiv and Media Query Support -->
<!--[if lt IE 9]>
  <script src="/assets/js/vendor/html5shiv.min.js"></script>
  <script src="/assets/js/vendor/respond.min.js"></script>
<![endif]-->

<!-- Modernizr -->
<script src="/assets/js/vendor/modernizr-2.7.1.custom.min.js"></script>


<!-- MathJax -->
<script src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script>


<!-- Icons -->
<!-- 16x16 -->
<link rel="shortcut icon" href="/favicon.ico">
<!-- 32x32 -->
<link rel="shortcut icon" href="/favicon.png">
<!-- 57x57 (precomposed) for iPhone 3GS, pre-2011 iPod Touch and older Android devices -->
<link rel="apple-touch-icon-precomposed" href="/images/apple-touch-icon-precomposed.png">
<!-- 72x72 (precomposed) for 1st generation iPad, iPad 2 and iPad mini -->
<link rel="apple-touch-icon-precomposed" sizes="72x72" href="/images/apple-touch-icon-72x72-precomposed.png">
<!-- 114x114 (precomposed) for iPhone 4, 4S, 5 and post-2011 iPod Touch -->
<link rel="apple-touch-icon-precomposed" sizes="114x114" href="/images/apple-touch-icon-114x114-precomposed.png">
<!-- 144x144 (precomposed) for iPad 3rd and 4th generation -->
<link rel="apple-touch-icon-precomposed" sizes="144x144" href="/images/apple-touch-icon-144x144-precomposed.png">

</head>

<body id="post">

<div class="navigation-wrapper">
  <nav role="navigation" id="site-nav" class="animated drop">
      <ul>
      
        
        <li><a href="/about/" >About</a></li>
      
        
        <li><a href="/articles/" >Articles</a></li>
      
        
        <li><a href="/blog/" >Blog</a></li>
      
      </ul>
  </nav>
</div><!-- /.navigation-wrapper -->

<!--[if lt IE 9]><div class="upgrade"><strong><a href="http://whatbrowser.org/">Your browser is quite old!</strong> Why not upgrade to a different browser to better enjoy this site?</a></div><![endif]-->

<div class="js-menu-screen menu-screen"></div>


<div id="main" role="main">
  <article class="hentry">
    
    <div class="entry-wrapper">
      <header class="entry-header">
        <ul class="entry-tags">
          
        </ul>
        
          <h1 class="entry-title">Akka系列（三）：监管与容错</h1>
        
      </header>
      <footer class="entry-meta">
        
        
          <img src="/images/bio-photo.jpg" class="bio-photo" alt="GodPan bio photo"></a>
        
        <span class="author vcard">By <span class="fn">GodPan</span></span>
        <span class="entry-date date published"><time datetime="2017-04-15T00:00:00+08:00"><i class="fa fa-calendar-o"></i> April 15, 2017</time></span>
        
        
        
        
      </footer>
      <div class="entry-content">
        <p>Akka作为一种成熟的生产环境并发解决方案，必须拥有一套完善的错误异常处理机制，本文主要讲讲Akka中的监管和容错。</p>

<h2 id="section">监管</h2>

<p>看过我上篇文章的同学应该对Actor系统的工作流程有了一定的了解<a href="http://www.godpan.me/blog/akka-2/">Akka系列（二）：Akka中的Actor系统</a>，它的很重要的概念就是分而治之，既然我们把任务分配给Actor去执行，那么我们必须去监管相应的Actor，当Actor出现了失败，比如系统环境错误，各种异常，能根据我们制定的相应监管策略进行错误恢复，就是后面我们会说到的容错。</p>

<h3 id="section-1">监管者</h3>

<p>既然有监管这一事件，那必然存在着<strong>监管者</strong>这么一个角色，那么在ActorSystem中是如何确定这种角色的呢？</p>

<p>我们先来看下ActorSystem中的顶级监管者：</p>

<p><img src="/images/actor-syatem-guardian.png" alt="Actor系统顶级监管者" /></p>

<p>一个actor系统在其创建过程中至少要启动三个actor，如上图所示，下面来说说这三个Actor的功能：</p>

<h4 id="section-2">1.<code class="highlighter-rouge">/</code>： 根监管者</h4>

<p>顾名思义，它是一个老大，它监管着ActorSystem中所有的顶级Actor，顶级Actor有以下几种：</p>

<ul>
  <li><code class="highlighter-rouge">/user</code>： 是所有由用户创建的顶级actor的监管者；用ActorSystem.actorOf创建的actor在其下。</li>
  <li><code class="highlighter-rouge">/system</code>： 是所有由系统创建的顶级actor的监管者，如日志监听器，或由配置指定在actor系统启动时自动部署的actor。</li>
  <li><code class="highlighter-rouge">/deadLetters</code>： 是死信actor，所有发往已经终止或不存在的actor的消息会被重定向到这里。</li>
  <li><code class="highlighter-rouge">/temp</code>：是所有系统创建的短时actor的监管者，例如那些在ActorRef.ask的实现中用到的actor。</li>
  <li><code class="highlighter-rouge">/remote</code>： 是一个人造虚拟路径，用来存放所有其监管者是远程actor引用的actor。</li>
</ul>

<p>跟我们平常打交道最多的就是<code class="highlighter-rouge">/user</code>，它是我们在程序中用ActorSystem.actorOf创建的actor的监管者，下面的容错我们重点关心的就是它下面的失败处理，其他几种顶级Actor具体功能定义已经给出，有兴趣的也可以去了解一下。</p>

<p>根监管者监管着所有顶级Actor，对它们的各种失败情况进行处理，一般来说如果错误要上升到根监管者，整个系统就会停止。</p>

<h4 id="user-actor">2.<code class="highlighter-rouge">/user</code>： 顶级actor监管者</h4>

<p>上面已经讲过<code class="highlighter-rouge">/user</code>是所有由用户创建的顶级actor的监管者，即用ActorSystem.actorOf创建的actor，我们可以自己制定相应的监管策略，但由于它是actor系统启动时就产生的，所以我们需要在相应的配置文件里配置，具体的配置可以参考这里<a href="http://doc.akka.io/docs/akka/current/general/configuration.html">Akka配置</a></p>

<h4 id="system-">3.<code class="highlighter-rouge">/system</code>： 系统监管者</h4>

<p><code class="highlighter-rouge">/system</code>所有由系统创建的顶级actor的监管者,比如Akka中的日志监听器，因为在Akka中日志本身也是用Actor实现的，<code class="highlighter-rouge">/system</code>的监管策略如下：对收到的除<code class="highlighter-rouge">ActorInitializationException</code>和<code class="highlighter-rouge">ActorKilledException</code>之外的所有<code class="highlighter-rouge">Exception</code>无限地执行重启，当然这也会终止其所有子actor。所有其他Throwable被上升到根监管者，然后整个actor系统将会关闭。</p>

<p>用户创建的普通actor的监管：</p>

<p>上一篇文章介绍了Actor系统的组织结构，它是一种树形结构，其实这种结构对actor的监管是非常有利的，Akka实现的是一种叫“父监管”的形式，每一个被创建的actor都由其父亲所监管，这种限制使得actor的监管结构隐式符合其树形结构，所以我们可以得出一个结论：</p>

<blockquote>
  <p>一个被创建的Actor肯定是一个被监管者，也可能是一个监管者，它监管着它的子级Actor</p>
</blockquote>

<h3 id="section-3">监管策略</h3>

<p>上面我们对ActorSystem中的监管角色有了一定的了解，那么到底是如何制定相应的监管策略呢？Akka中有以下4种策略：</p>

<ul>
  <li>恢复下属，保持下属当前积累的内部状态</li>
  <li>重启下属，清除下属的内部状态</li>
  <li>永久地停止下属</li>
  <li>升级失败（沿监管树向上传递失败），由此失败自己</li>
</ul>

<p>这其实很好理解，下面是一个简单例子：</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code> <span class="k">override</span> <span class="k">val</span> <span class="n">supervisorStrategy</span> <span class="k">=</span>
    <span class="nc">OneForOneStrategy</span><span class="o">(</span><span class="n">maxNrOfRetries</span> <span class="k">=</span> <span class="mi">10</span><span class="o">,</span> <span class="n">withinTimeRange</span> <span class="k">=</span> <span class="mi">1</span> <span class="n">minute</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="k">_:</span> <span class="kt">ArithmeticException</span> <span class="o">=&gt;</span> <span class="nc">Resume</span>  <span class="c1">//恢复
</span>      <span class="k">case</span> <span class="k">_:</span> <span class="kt">NullPointerException</span> <span class="o">=&gt;</span> <span class="nc">Restart</span> <span class="c1">//重启
</span>      <span class="k">case</span> <span class="k">_:</span> <span class="kt">IllegalArgumentException</span> <span class="o">=&gt;</span> <span class="nc">Stop</span> <span class="c1">//停止
</span>      <span class="k">case</span> <span class="k">_:</span> <span class="kt">Exception</span> <span class="o">=&gt;</span> <span class="nc">Escalate</span>  <span class="c1">//向上级传递
</span>    <span class="o">}</span>
</code></pre>
</div>

<p>我们可以根据异常的不同使用不同监管策略，在后面我会具体给出一个示例程序帮助大家理解。我们在实现自己的策略时，需要复写Actor中的<code class="highlighter-rouge">supervisorStrategy</code>，因为Actor的默认监管策略如下：</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code>  <span class="k">final</span> <span class="k">val</span> <span class="n">defaultDecider</span><span class="k">:</span> <span class="kt">Decider</span> <span class="o">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="k">_:</span> <span class="kt">ActorInitializationException</span> <span class="k">⇒</span> <span class="kt">Stop</span>
    <span class="k">case</span> <span class="k">_:</span> <span class="kt">ActorKilledException</span>         <span class="k">⇒</span> <span class="kt">Stop</span>
    <span class="k">case</span> <span class="k">_:</span> <span class="kt">DeathPactException</span>           <span class="k">⇒</span> <span class="kt">Stop</span>
    <span class="k">case</span> <span class="k">_:</span> <span class="kt">Exception</span>                    <span class="k">⇒</span> <span class="kt">Restart</span>
  <span class="o">}</span>
</code></pre>
</div>
<p>它对除了它指定的异常进行停止，其他异常都是对下属进行重启。</p>

<p>Akka中有两种类型的监管策略：<code class="highlighter-rouge">OneForOneStrategy</code>和<code class="highlighter-rouge">AllForOneStrategy</code>，它们的主要区别在于：</p>

<ul>
  <li><code class="highlighter-rouge">OneForOneStrategy</code>： 该策略只会应用到发生故障的子actor上。</li>
  <li><code class="highlighter-rouge">AllForOneStrategy</code>： 该策略会应用到所有的子actor上。</li>
</ul>

<p>我们一般都使用<code class="highlighter-rouge">OneForOneStrategy</code>来进行制定相关监管策略，当然你也可以根据具体需求选择合适的策略。另外我们可以给我们的策略配置相应参数，比如上面maxNrOfRetries，withinTimeRange等，这里的含义是每分钟最多进行10次重启，若超出这个界限相应的Actor将会被停止，当然你也可以使用策略的默认配置，具体配置信息可以参考源码。</p>

<h3 id="section-4">监管容错示例</h3>

<p>本示例主要演示Actor在发生错误时，它的监管者会根据相应的监管策略进行不同的处理。<a href="https://github.com/godpan/akka-demo/tree/master/Example_03">源码链接</a></p>

<p>因为这个例子比较简单，这里我直接贴上相应代码，后面根据具体的测试用例来解释各种监管策略所进行的响应：</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">Supervisor</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="c1">//监管下属，根据下属抛出的异常进行相应的处理
</span>  <span class="k">override</span> <span class="k">val</span> <span class="n">supervisorStrategy</span> <span class="k">=</span>
    <span class="nc">OneForOneStrategy</span><span class="o">(</span><span class="n">maxNrOfRetries</span> <span class="k">=</span> <span class="mi">10</span><span class="o">,</span> <span class="n">withinTimeRange</span> <span class="k">=</span> <span class="mi">1</span> <span class="n">minute</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">case</span> <span class="k">_:</span> <span class="kt">ArithmeticException</span> <span class="o">=&gt;</span> <span class="nc">Resume</span>
      <span class="k">case</span> <span class="k">_:</span> <span class="kt">NullPointerException</span> <span class="o">=&gt;</span> <span class="nc">Restart</span>
      <span class="k">case</span> <span class="k">_:</span> <span class="kt">IllegalArgumentException</span> <span class="o">=&gt;</span> <span class="nc">Stop</span>
      <span class="k">case</span> <span class="k">_:</span> <span class="kt">Exception</span> <span class="o">=&gt;</span> <span class="nc">Escalate</span>
    <span class="o">}</span>
  <span class="k">var</span> <span class="n">childIndex</span> <span class="k">=</span> <span class="mi">0</span> <span class="c1">//用于标示下属Actor的序号
</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">p</span><span class="k">:</span> <span class="kt">Props</span> <span class="o">=&gt;</span>
      <span class="n">childIndex</span> <span class="o">+=</span> <span class="mi">1</span>
      <span class="c1">//返回一个Child Actor的引用，所以Supervisor Actor是Child Actor的监管者
</span>      <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="n">context</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="n">p</span><span class="o">,</span><span class="n">s</span><span class="s">"child${childIndex}"</span><span class="o">)</span>
  <span class="o">}</span>
<span class="o">}</span>

<span class="k">class</span> <span class="nc">Child</span> <span class="k">extends</span> <span class="nc">Actor</span> <span class="o">{</span>
  <span class="k">val</span> <span class="n">log</span> <span class="k">=</span> <span class="nc">Logging</span><span class="o">(</span><span class="n">context</span><span class="o">.</span><span class="n">system</span><span class="o">,</span> <span class="k">this</span><span class="o">)</span>
  <span class="k">var</span> <span class="n">state</span> <span class="k">=</span> <span class="mi">0</span>
  <span class="k">def</span> <span class="n">receive</span> <span class="k">=</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">ex</span><span class="k">:</span> <span class="kt">Exception</span> <span class="o">=&gt;</span> <span class="k">throw</span> <span class="n">ex</span> <span class="c1">//抛出相应的异常
</span>    <span class="k">case</span> <span class="n">x</span><span class="k">:</span> <span class="kt">Int</span> <span class="o">=&gt;</span> <span class="n">state</span> <span class="k">=</span> <span class="n">x</span> <span class="c1">//改变自身状态
</span>    <span class="k">case</span> <span class="n">s</span><span class="k">:</span> <span class="kt">Command</span> <span class="kt">if</span> <span class="kt">s.content</span> <span class="o">=</span><span class="k">=</span> <span class="s">"get"</span> <span class="k">=&gt;</span>
      <span class="n">log</span><span class="o">.</span><span class="n">info</span><span class="o">(</span><span class="n">s</span><span class="s">"the ${s.self} state is ${state}"</span><span class="o">)</span>
      <span class="n">sender</span><span class="o">()</span> <span class="o">!</span> <span class="n">state</span> <span class="c1">//返回自身状态
</span>  <span class="o">}</span>
<span class="o">}</span>

<span class="k">case</span> <span class="k">class</span> <span class="nc">Command</span><span class="o">(</span>  <span class="c1">//相应命令
</span>    <span class="n">content</span><span class="k">:</span> <span class="kt">String</span><span class="o">,</span>
    <span class="n">self</span><span class="k">:</span> <span class="kt">String</span>
<span class="o">)</span>
</code></pre>
</div>
<p>现在我们来看看具体的测试用例：
首先我们先构建一个测试环境：</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">class</span> <span class="nc">GuardianSpec</span><span class="o">(</span><span class="nc">_system</span><span class="k">:</span> <span class="kt">ActorSystem</span><span class="o">)</span>
    <span class="k">extends</span> <span class="nc">TestKit</span><span class="o">(</span><span class="nc">_system</span><span class="o">)</span>
    <span class="k">with</span> <span class="nc">WordSpecLike</span>
    <span class="k">with</span> <span class="nc">Matchers</span>
    <span class="k">with</span> <span class="nc">ImplicitSender</span> <span class="o">{</span>

  <span class="k">def</span> <span class="k">this</span><span class="o">()</span> <span class="k">=</span> <span class="k">this</span><span class="o">(</span><span class="nc">ActorSystem</span><span class="o">(</span><span class="s">"GuardianSpec"</span><span class="o">))</span>

  <span class="s">"A supervisor"</span> <span class="n">must</span> <span class="o">{</span>

    <span class="s">"apply the chosen strategy for its child"</span> <span class="n">in</span> <span class="o">{</span>
        <span class="n">code</span> <span class="n">here</span><span class="o">...</span>
        <span class="k">val</span> <span class="n">supervisor</span> <span class="k">=</span> <span class="n">system</span><span class="o">.</span><span class="n">actorOf</span><span class="o">(</span><span class="nc">Props</span><span class="o">[</span><span class="kt">Supervisor</span><span class="o">],</span> <span class="s">"supervisor"</span><span class="o">)</span> <span class="c1">//创建一个监管者
</span>        <span class="n">supervisor</span> <span class="o">!</span> <span class="nc">Props</span><span class="o">[</span><span class="kt">Child</span><span class="o">]</span>
        <span class="k">val</span> <span class="n">child</span> <span class="k">=</span> <span class="n">expectMsgType</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">]</span> <span class="c1">// 从 TestKit 的 testActor 中获取回应
</span>    <span class="o">}</span> 
  <span class="o">}</span>
<span class="o">}</span>
</code></pre>
</div>

<p>1.TestOne：正常运行</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">child</span> <span class="o">!</span> <span class="mi">50</span> <span class="c1">// 将状态设为 50
</span><span class="n">child</span> <span class="o">!</span> <span class="nc">Command</span><span class="o">(</span><span class="s">"get"</span><span class="o">,</span><span class="n">child</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
<span class="n">expectMsg</span><span class="o">(</span><span class="mi">50</span><span class="o">)</span>
</code></pre>
</div>
<p>正常运行，测试通过。</p>

<p>2.TestTwo：抛出ArithmeticException</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">child</span> <span class="o">!</span> <span class="k">new</span> <span class="nc">ArithmeticException</span> <span class="c1">// crash it
</span><span class="n">child</span> <span class="o">!</span> <span class="nc">Command</span><span class="o">(</span><span class="s">"get"</span><span class="o">,</span><span class="n">child</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
<span class="n">expectMsg</span><span class="o">(</span><span class="mi">50</span><span class="o">)</span>     
</code></pre>
</div>
<p>大家猜这时候测试会通过吗？答案是通过，原因是根据我们制定的监管策略，监管者在面对子级Actor抛出<code class="highlighter-rouge">ArithmeticException</code>异常时，它会去恢复相应出异常的Actor，并保持该Actor的状态，所以此时Actor的状态值还是50，测试通过。</p>

<p>3.TestThree：抛出NullPointerException</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">child</span> <span class="o">!</span> <span class="k">new</span> <span class="nc">NullPointerException</span> <span class="c1">// crash it harder
</span><span class="n">child</span> <span class="o">!</span> <span class="s">"get"</span>
<span class="n">expectMsg</span><span class="o">(</span><span class="mi">50</span><span class="o">)</span>   
</code></pre>
</div>
<p>这种情况下测试还会通过吗？答案是不通过，原因是根据我们制定的监管策略，监管者在面对子级Actor抛出<code class="highlighter-rouge">NullPointerException</code>异常时，它会去重启相应出异常的Actor，其状态会被清除，所以此时Actor的状态值应该是0，测试不通过。</p>

<p>4.TestFour：抛出IllegalArgumentException</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="n">supervisor</span> <span class="o">!</span> <span class="nc">Props</span><span class="o">[</span><span class="kt">Child</span><span class="o">]</span> <span class="c1">// create new child
</span><span class="k">val</span> <span class="n">child2</span> <span class="k">=</span> <span class="n">expectMsgType</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">]</span>
<span class="n">child2</span> <span class="o">!</span> <span class="mi">100</span> <span class="c1">// 将状态设为 100
</span><span class="n">watch</span><span class="o">(</span><span class="n">child</span><span class="o">)</span> <span class="c1">// have testActor watch “child”
</span><span class="n">child</span> <span class="o">!</span> <span class="k">new</span> <span class="nc">IllegalArgumentException</span> <span class="c1">// break it
</span><span class="n">expectMsgPF</span><span class="o">()</span> <span class="o">{</span>
  <span class="k">case</span> <span class="nc">Terminated</span><span class="o">(</span><span class="n">`child`</span><span class="o">)</span> <span class="k">=&gt;</span> <span class="o">(</span><span class="n">println</span><span class="o">(</span><span class="s">"the child stop"</span><span class="o">))</span>
<span class="o">}</span>
<span class="n">child2</span> <span class="o">!</span> <span class="nc">Command</span><span class="o">(</span><span class="s">"get"</span><span class="o">,</span><span class="n">child2</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
<span class="n">expectMsg</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>   
</code></pre>
</div>
<p>这里首先我们又创建了一个Child Actor为child2，并将它的状态置为100，这里我们监控前面创建的child1，然后给其发送一个<code class="highlighter-rouge">IllegalArgumentException</code>的消息，让其抛出该异常，测试结果:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>the child stop
测试通过
</code></pre>
</div>
<p>从结果中我们可以看出，child在抛出<code class="highlighter-rouge">IllegalArgumentException</code>后，会被其监管着停止，但监管者下的其他Actor还是正常工作。</p>

<p>5.TestFive：抛出一个自定义异常</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code> <span class="n">watch</span><span class="o">(</span><span class="n">child2</span><span class="o">)</span>
 <span class="n">child2</span> <span class="o">!</span> <span class="nc">Command</span><span class="o">(</span><span class="s">"get"</span><span class="o">,</span><span class="n">child2</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">)</span> <span class="c1">// verify it is alive
</span> <span class="n">expectMsg</span><span class="o">(</span><span class="mi">100</span><span class="o">)</span>
 <span class="n">supervisor</span> <span class="o">!</span> <span class="nc">Props</span><span class="o">[</span><span class="kt">Child</span><span class="o">]</span> <span class="c1">// create new child
</span> <span class="k">val</span> <span class="n">child3</span> <span class="k">=</span> <span class="n">expectMsgType</span><span class="o">[</span><span class="kt">ActorRef</span><span class="o">]</span>
 <span class="n">child2</span> <span class="o">!</span> <span class="k">new</span> <span class="nc">Exception</span><span class="o">(</span><span class="s">"CRASH"</span><span class="o">)</span> <span class="c1">// escalate failure
</span> <span class="n">expectMsgPF</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">case</span> <span class="n">t</span> <span class="k">@</span> <span class="nc">Terminated</span><span class="o">(</span><span class="n">`child2`</span><span class="o">)</span> <span class="k">if</span> <span class="n">t</span><span class="o">.</span><span class="n">existenceConfirmed</span> <span class="k">=&gt;</span> <span class="o">(</span>
       <span class="n">println</span><span class="o">(</span><span class="s">"the child2 stop"</span><span class="o">)</span>
    <span class="o">)</span>
<span class="o">}</span>
<span class="n">child3</span> <span class="o">!</span> <span class="nc">Command</span><span class="o">(</span><span class="s">"get"</span><span class="o">,</span><span class="n">child3</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">name</span><span class="o">)</span>
<span class="n">expectMsg</span><span class="o">(</span><span class="mi">0</span><span class="o">)</span>  
</code></pre>
</div>
<p>这里首先我们又创建了一个Child Actor为child3,这里我们监控前面创建的child2,然后给其发送一个<code class="highlighter-rouge">Exception("CRASH")</code>的消息，让其抛出该异常,测试结果:</p>
<div class="highlighter-rouge"><pre class="highlight"><code>the child2 stop
测试不通过
</code></pre>
</div>

<p>很多人可能会疑惑为什么TestFour可以通过，这里就通不过不了呢？因为这里错误Actor抛出的异常其监管者无法处理，只能将失败上溯传递，而顶级actor的缺省策略是对所有的Exception情况（ActorInitializationException和ActorKilledException例外）进行重启. 由于缺省的重启指令会停止所有的子actor，所以我们这里的child3也会被停止。导致测试不通过。当然这里你也可以复写默认的重启方法，比如：</p>

<div class="language-scala highlighter-rouge"><pre class="highlight"><code><span class="k">override</span> <span class="k">def</span> <span class="n">preRestart</span><span class="o">(</span><span class="n">cause</span><span class="k">:</span> <span class="kt">Throwable</span><span class="o">,</span> <span class="n">msg</span><span class="k">:</span> <span class="kt">Option</span><span class="o">[</span><span class="kt">Any</span><span class="o">])</span> <span class="o">{}</span>
</code></pre>
</div>

<p>这样重启相应Actor时就不会停止其子级下的所有Actor了。</p>

<p>本文主要介绍了Actor系统中的监管和容错，这一部分内容在Akka中也是很重要的，它与Actor的树形组织结构巧妙结合，本文大量参考了Akka官方文档的相应章节，有兴趣的同学可以点击这里<a href="http://doc.akka.io/docs/akka/2.5/scala/fault-tolerance.html">Akka docs</a>。也可以下载我的示例程序，里面包含了一个官方的提供的容错示例。</p>

        
      </div><!-- /.entry-content -->
    </div><!-- /.entry-wrapper -->
    <div class="correct-tip-box">
      <span>文章允许转载、使用，但需要保留文章署名
<a href="http://www.godpan.me">godpan.me</a>,如有写的不当之处，也欢迎大家指正，联系邮箱：godpan.sen@gmail.com</span>
    </div>
    <nav class="pagination" role="navigation">
      
        <a href="/blog/akka-2/" class="btn" title="Akka系列（二）：Akka中的Actor系统">Previous</a>
      
      
    </nav><!-- /.pagination -->
  </article>
</div><!-- /#main -->
<!-- 
<div class="correct-tip-box">
    <span>文章允许转载、使用，但需要保留文章署名
<a href="http://www.godpan.me">godpan.me</a>,如有写的不当之处，也欢迎大家指正，联系邮箱：godpan.sen@gmail.com</span>
</div> -->

<div class="footer-wrapper">
  <footer role="contentinfo" class="entry-wrapper">
    

<span>&copy; 2017 GodPan.</span>
<div class="social-icons">
	
	
	
	
	
	
	
	<a href="https://github.com/godpan" title="GodPan on Github" target="_blank"><i class="fa fa-github-square fa-2x"></i></a>
	
  
	
</div><!-- /.social-icons -->

  </footer>
</div><!-- /.footer-wrapper -->

<script type="text/javascript">
  var BASE_URL = '';
</script>

<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "https://hm.baidu.com/hm.js?97a996faebe648d21debdaf60f01d40b";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>

<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
<script>window.jQuery || document.write('<script src="/assets/js/vendor/jquery-1.9.1.min.js"><\/script>')</script>
<script src="/assets/js/scripts.min.js"></script>




</body>
</html>
